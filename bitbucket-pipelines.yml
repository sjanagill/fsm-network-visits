#  Template python-build

#  This template allows you to validate your python code.
#  The workflow allows running tests and code linting on the default branch.

image: python:3.8

pipelines:
  default:

    - step:
        name: Checkout code
        script:
          - git clone https://bitbucket.org/sonikaj/fsm-network-visits.git

    - step:
        name: Pre-deploy steps
        script:
          - rm /bin/sh && ln -s /bin/bash /bin/sh && apt-get update && apt-get install -y git
          - python3 -m venv .venv
          - source .venv/bin/activate
          - pip install --upgrade pip
          - export PYTHONPATH="${PYTHONPATH}:."

    - step:
        name: Install dependencies
        script:
          - bash install_requirements.sh

    - step:
        name: Run static code checks
        script:
          - bash run_linters.sh


    - step:
        image: hashicorp/terraform:latest
        name: Deploy with Terraform
        # Requires Terraform CLI pre-installed
        script:
          - pip install --no-cache-dir --timeout 30 -r requirements.txt
          - export PYTHONPATH="${PYTHONPATH}:."
          - wget -c https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-388.0.0-linux-x86_64.tar.gz
          - tar -xf google-cloud-sdk-388.0.0-linux-x86_64.tar.gz
          - curl https://sdk.cloud.google.com > install.sh
          - bash install.sh --disable-prompts > /dev/null
          - ls -la ~/google-cloud-sdk
          - . ~/google-cloud-sdk/completion.bash.inc
          - . ~/google-cloud-sdk/path.bash.inc
          - gcloud info
          - export PATH=". ~/google-cloud-sdk/bin/:$PATH"
          - gcloud version
          - echo $SA_AUTH > /tmp/sa-auth.json
          - chmod 777 /tmp/sa-auth.json
          - gcloud auth activate-service-account $SA_NAME --key-file=/tmp/sa-auth.json --project="fsm-network"
          - gcloud config set project "fsm-network"
          - bash deploy.sh

#variables:
#  BITBUCKET_BUILD_NUMBER: $BITBUCKET_BUILD_NUMBER  # Replace with your variable name for build number (optional)
